#!/bin/bash

HOSTS_FILE="/etc/hosts"
BACKUP_FILE="/etc/hosts.bkp"

generate_entries() {
    # Restore backup and add header
    {
        echo "# Auto-generated by docker-sync"
        cat "$BACKUP_FILE"
    } > "$HOSTS_FILE"

    for cid in $(docker ps -q); do
        name=$(docker inspect -f '{{.Name}}' "$cid" | sed 's|/||')
        ip=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "$cid")
        # Only add entry if both name and ip are not empty and name is not just the container ID
        if [[ -n "$ip" && -n "$name" && "$name" != "$cid" ]]; then
            echo "$ip $name" >> "$HOSTS_FILE"
        fi
    done
    systemctl restart dnsmasq
}

generate_entries

# Watch docker events to keep it in sync
docker events --filter 'event=start' --filter 'event=stop' --filter 'event=die' | while read -r _; do
    generate_entries
done